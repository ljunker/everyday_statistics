<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Everyday Statistics</title>

  <!-- Bootstrap CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-api-key="{{ api_key }}">

  <div class="container py-5">
    <h1 class="mb-4">Everyday Statistics Dashboard</h1>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger mb-4">Logout</a>

    <!-- Dropdown for selecting type -->
    <div class="mb-4">
      <label for="typeSelect" class="form-label">Select Event Type:</label>
      <select id="typeSelect" class="form-select" style="max-width: 300px;">
        <option value="">All Types</option>
      </select>
    </div>

    <!-- Stats cards -->
    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Today</h5>
            <p class="card-text"><span id="today_count">0</span></p>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Total</h5>
            <p class="card-text"><span id="total_count">0</span></p>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Average per Day</h5>
            <p class="card-text"><span id="average_per_day">0</span></p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Longest Streak</h5>
            <p class="card-text"><span id="longest_streak_days">0</span> days</p>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Most Active Day</h5>
            <p class="card-text">
              <span id="most_active_day">N/A</span>
              (<span id="most_active_day_count">0</span>)
            </p>
          </div>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <h5 class="card-title">Busiest Hour</h5>
            <p class="card-text"><span id="busiest_hour">N/A</span></p>
          </div>
        </div>
      </div>
    </div>

    <h2 class="mt-5">Your Events Chart</h2>
    <canvas id="eventsChart" height="100"></canvas>
  </div>

  <script>
    let chart; // Store Chart.js instance

    async function fetchTypes() {
      const apiKey = document.body.dataset.apiKey;

      const res = await fetch('/types', {
        headers: { 'X-API-KEY': apiKey }
      });
      const data = await res.json();
      return data.event_types || [];
    }

    async function loadStats(eventType = '') {
      const apiKey = document.body.dataset.apiKey;
      const url = eventType ? `/stats?type=${encodeURIComponent(eventType)}` : '/stats';

      const res = await fetch(url, {
        headers: { 'X-API-KEY': apiKey }
      });

      const data = await res.json();

      document.getElementById('today_count').innerText = data.today_count;
      document.getElementById('total_count').innerText = data.total_count;
      document.getElementById('average_per_day').innerText = data.average_per_day;
      document.getElementById('longest_streak_days').innerText = data.longest_streak_days;
      document.getElementById('most_active_day').innerText = data.most_active_day || 'N/A';
      document.getElementById('most_active_day_count').innerText = data.most_active_day_count;
      document.getElementById('busiest_hour').innerText = data.busiest_hour !== null ? data.busiest_hour + ':00' : 'N/A';

      // (Re)draw Chart
      const ctx = document.getElementById('eventsChart').getContext('2d');

      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Today', 'Total'],
          datasets: [{
            label: eventType ? `# of "${eventType}" events` : '# of Events (All)',
            data: [data.today_count, data.total_count],
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function init() {
      const types = await fetchTypes();
      const select = document.getElementById('typeSelect');

      // Populate dropdown
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.innerText = type;
        select.appendChild(opt);
      });

      // Load stats initially (all)
      await loadStats('');

      // Handle selection change
      select.addEventListener('change', () => {
        const selectedType = select.value || '';
        loadStats(selectedType);
      });
    }

    init();
  </script>
</body>
</html>
